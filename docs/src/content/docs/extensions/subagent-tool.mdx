---
title: subagent-tool
description: Spawn parallel agents with isolated contexts and model routing.
---

import Gallery from '../../../components/Gallery.astro';

Delegate tasks to specialized agents, each running as a separate
tallow process with its own context window. Three execution modes:

- **Single**, one agent, one task, wait for result
- **Parallel**, multiple independent tasks running concurrently
- **Centipede**, sequential steps where each receives the previous
  output via `{previous}` placeholder

Each subagent can use a different model, have a different role
description, and work in a different directory. JSON mode captures
structured output for the parent agent to process.

### Foreground

Multiple agents run in parallel but the conversation blocks
until all finish. Results appear inline.

<Gallery images={[
  { src: "/screenshots/extensions/subagent/parallel-running.png", alt: "Four parallel agents running on different models" },
  { src: "/screenshots/extensions/subagent/parallel-complete.png", alt: "Parallel agents complete with results summary" },
]} />

### Background

Agents run independently while the conversation continues.
Check progress with `subagent_status`. These are background
**agents**, not to be confused with
[background tasks](/extensions/background-task-tool/) which are
raw shell commands. Background agents are full tallow processes
with their own context, tools, and model access. Both appear
in the widget but in separate sections.

<Gallery images={[
  { src: "/screenshots/extensions/subagent/background-agents.png", alt: "Five background agents running alongside a background task" },
]} />

## Foreground vs background agents

Subagents run in two modes:

- **Foreground**, the parent agent blocks waiting for the result.
  Used in single mode and centipede mode where the output feeds back
  into the next step.
- **Background**, the agent runs independently. Used when the
  parent says `background: true`. The agent works while the
  conversation continues.

Both types appear in the [tasks](/extensions/tasks/) widget with
colored `@name` identifiers, live activity status, and elapsed
time. Background agents persist until their task completes or
the session ends.

## Interrupting with Escape

When you press Escape, background **agents** are killed but
background **tasks** are not. Agents are delegated cognitive
work tied to the conversation — if you interrupt, you want all
agent work to stop. Background tasks (dev servers, builds, test
watchers) are infrastructure that should keep running.

<Gallery images={[
  { src: "/screenshots/extensions/subagent/full-dashboard.png", alt: "Tasks, foreground agents, background agents, and background tasks running together" },
]} />

## Agent configuration

Agents are defined in markdown files in agent directories. They support
frontmatter fields that control tool access, resource limits, and model routing.

### Agent directories

Agents are loaded from multiple locations with a priority system:

1. **Bundled agents** — shipped with tallow
2. **Package agents** — from settings.json packages
3. **~/.claude/agents/** — user-level, Claude Code compatibility
4. **~/.tallow/agents/** — user-level, tallow
5. **Project .claude/agents/** — project root, Claude Code compatibility
6. **Project .tallow/agents/** — project root, tallow

Project root is determined by `git rev-parse --show-toplevel`, falling back
to the current working directory when not in a git repo. This replaces the
previous ancestor-walk behavior.

Priority: last wins per name. Within a scope, `.tallow/` takes precedence over
`.claude/`. This means a project `.tallow/agents/researcher.md` overrides both
`.claude/agents/researcher.md` in the same directory and `~/.tallow/agents/researcher.md`.

### Model inheritance

Subagents inherit the parent session's model by default. Precedence:

1. **Per-call** `model` parameter (highest)
2. **Agent frontmatter** `model` field
3. **Parent session model** (inherited automatically)

This means you don't need to specify a model in most cases — agents
use whatever model you're running in the main session.

### Missing agent recovery

When a requested agent name doesn't match any discovered agent, the tool
recovers gracefully instead of erroring:

1. **Exact match** — found agent with matching name
2. **Best match** — fuzzy match (prefix, suffix, contains) above a
   confidence threshold
3. **Ephemeral** — creates a temporary agent with built-in defaults

The result metadata shows the resolution source (`user`, `project`,
`ephemeral`) for transparency.

### Defaults configuration

Create a `_defaults.md` file in any agent directory to set fallback
values for all agents:

```markdown
---
maxTurns: 25
tools: read, bash, edit, write, grep, find, ls
missingAgentBehavior: match-or-ephemeral
---
```

Supported in:
- `~/.tallow/agents/_defaults.md` (user-level)
- `~/.claude/agents/_defaults.md` (user-level)
- `<project>/.tallow/agents/_defaults.md` (project-level)
- `<project>/.claude/agents/_defaults.md` (project-level)

Precedence: project defaults override user defaults. Defaults only
apply when neither the per-call parameters nor the agent frontmatter
specify a value.

### Agent frontmatter fields

#### `disallowedTools`

Tool denylist — removes tools from the default set. Takes precedence over the
`tools:` allowlist.

```yaml
---
name: researcher
description: Research agent with restricted write access
tools: read, bash, edit, write
disallowedTools: bash, write
---
```

Effective tools: `read, edit` (allowlist minus denylist).

If only `disallowedTools` is set, it filters against the built-in tool set:
`read, bash, edit, write, grep, find, ls`.

```yaml
---
name: safe-analyzer
description: Read-only analysis agent
disallowedTools: bash, write, edit
---
```

Effective tools: `read, grep, find, ls`.

The subprocess is spawned with `--tools <effective-list>`.

#### `maxTurns`

Hard limit on tool-use turns. When the subprocess reaches this many `tool_call`
events, it receives SIGTERM (then SIGKILL after 5 seconds).

```yaml
---
name: quick-search
description: Fast search with budget limit
maxTurns: 5
---
```

The extension injects a budget hint into the subprocess system prompt:

> You have a maximum of 5 tool-use turns for this task. Plan your approach to
> complete within this budget. If you are running low, output your best result
> immediately.

When the limit is reached, the result includes a `[Terminated: reached maxTurns
limit of 5]` annotation.

This is **hard enforcement** — the process is killed. Compare with
[agent-commands-tool](/extensions/agent-commands-tool/) which does soft
enforcement only (system prompt hint, no kill).

#### `mcpServers`

Restrict which MCP servers connect in the subprocess. Passes server names as
`PI_MCP_SERVERS=slack,github` environment variable.

```yaml
---
name: github-helper
description: Agent with GitHub MCP access only
mcpServers: github
---
```

Multiple servers:

```yaml
mcpServers: slack, github, linear
```

Or as YAML array:

```yaml
mcpServers:
  - slack
  - github
```

Inline server definitions (objects) are **not supported** in v1:

```yaml
mcpServers:
  - name: custom-server
    command: node
    args: [server.js]
```

This will show a warning and be skipped. Use string references to servers
configured in `~/.tallow/settings.json` or `.tallow/settings.json`.

See [mcp-adapter-tool](/extensions/mcp-adapter-tool/) for how PI_MCP_SERVERS
filtering works.

### Full agent example

```markdown
---
name: test-writer
description: Writes tests with restricted tool access and turn limit
tools: read, bash, edit, write
disallowedTools: write
mcpServers: github
maxTurns: 15
model: sonnet
---

You are a test writing specialist. Your job is to read existing code,
understand the patterns, and write comprehensive test suites.

Focus on:
- Edge cases and error handling
- Clear test names and descriptions
- Minimal setup/teardown

Use the GitHub MCP server to check for existing test conventions in the repo.
```

## Relationships with other extensions

### [tasks](/extensions/tasks/)

Subagents and the task board are deeply integrated. When a
subagent claims a task (via `manage_tasks` with `owner`), the
task widget shows `(@agent-name)` attribution in the agent's
color. The in-progress spinner animates only while the owning
agent is actively running, if the agent finishes but the task
isn't marked complete, the spinner switches to a static `●`
indicator.

In-progress tasks show their `activeForm` text (e.g.,
"Writing tests") instead of the subject, giving live visibility
into what each agent is doing.

On wide terminals, running agents appear in a right column
alongside the task list. On narrow terminals, they stack below.
See [tasks, responsive layout](/extensions/tasks/#responsive-layout)
for the full breakdown.

### [background-tasks](/extensions/background-task-tool/)

Subagents and background bash tasks share display space in the
[tasks](/extensions/tasks/) widget. When both are active, agents
render above background tasks with a spacer between. Each gets
independent truncation based on the available width.

### [custom-footer](/extensions/custom-footer/)

The footer shows a `(sub)` count when subagents are running. The
tasks extension adds a separate agent bar to the status area:
`@main @alice @bob · 2 teammates` with colored names matching
the widget display.
